@page "/register"
@using System.Net.Http
@using System.Net.Http.Json
@using if_hub.ViewModels
@using System.Net.Http.Headers
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Registrar - iF-Hub</PageTitle>

<div class="flex flex-col items-center">
    <div class="w-full max-w-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#222831]">Crie sua Conta</h1>
            <p class="meta-text mt-2">Junte-se à comunidade iF-Hub.</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Erro: </strong>
                <span class="block sm:inline">@errorMessage</span>
            </div>
        }

        <article class="topic-card bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <EditForm Model="@registerModel" OnValidSubmit="HandleRegistration">
                <DataAnnotationsValidator />

                <div class="space-y-6">
                    <div>
                        <label for="nome" class="block mb-2 text-sm font-medium text-gray-900">Nome</label>
                        <InputText id="nome" @bind-Value="registerModel.Nome" class="w-full px-4 py-2 border search-input rounded-lg focus:ring-2 outline-none transition" placeholder="Seu nome completo" />
                        <ValidationMessage For="@(() => registerModel.Nome)" />
                    </div>

                    <div>
                        <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label>
                        <InputText id="email" type="email" @bind-Value="registerModel.Email" class="w-full px-4 py-2 border search-input rounded-lg focus:ring-2 outline-none transition" placeholder="seu.email@exemplo.com" />
                        <ValidationMessage For="@(() => registerModel.Email)" />
                    </div>

                    <div>
                        <label for="senha" class="block mb-2 text-sm font-medium text-gray-900">Senha</label>
                        <InputText id="senha" type="password" @bind-Value="registerModel.Senha" class="w-full px-4 py-2 border search-input rounded-lg focus:ring-2 outline-none transition" placeholder="••••••••" />
                        <ValidationMessage For="@(() => registerModel.Senha)" />
                    </div>

                    <button type="submit" class="create-topic-button font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 flex items-center justify-center w-full">
                        <span>Criar Conta</span>
                    </button>
                </div>
            </EditForm>
        </article>

        <div class="text-center mt-6">
            <p class="text-sm meta-text">
                Já tem uma conta?
                <a href="/login" class="font-medium topic-title-link transition duration-150">Faça o login aqui</a>
            </p>
        </div>
    </div>
</div>


@code {    
    private RegisterViewModel registerModel = new();
    private string? errorMessage;

    private async Task HandleRegistration()
    {
        try
        {
            errorMessage = null;
            var response = await Http.PostAsJsonAsync("/api/auth/register", registerModel);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Erro ao registrar. O e-mail pode já estar em uso.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocorreu um erro de conexão: {ex.Message}";
        }
    }
}